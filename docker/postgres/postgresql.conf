# PostgreSQL 17 Performance Tuning Configuration
# Docker 환경: 2 CPU, 2GB RAM 가정

# ===================================================================
# CONNECTIONS AND AUTHENTICATION
# ===================================================================
listen_addresses = '*'
max_connections = 200
superuser_reserved_connections = 3

# ===================================================================
# MEMORY SETTINGS (2GB RAM 기준)
# ===================================================================

# Shared Buffers: 전체 메모리의 25% (권장)
shared_buffers = 512MB

# Effective Cache Size: 전체 메모리의 75% (OS cache 포함)
effective_cache_size = 1536MB

# Work Memory: 정렬, 해시 조인 등에 사용 (per operation)
work_mem = 16MB

# Maintenance Work Memory: VACUUM, CREATE INDEX 등에 사용
maintenance_work_mem = 256MB

# ===================================================================
# QUERY PLANNER
# ===================================================================

# SSD 사용 가정 (기본값 4.0, SSD는 1.0-1.1 권장)
random_page_cost = 1.1

# Parallel Query (대량 데이터 처리 최적화)
max_parallel_workers_per_gather = 4
max_parallel_workers = 4
max_worker_processes = 8

# SSD 동시 I/O 처리 능력
effective_io_concurrency = 200

# 통계 샘플링
default_statistics_target = 100

# ===================================================================
# WAL (Write-Ahead Logging) - 성능 최적화
# ===================================================================

# WAL Buffers
wal_buffers = 16MB

# Checkpoint 설정 (성능과 복구 시간의 균형)
min_wal_size = 1GB
max_wal_size = 4GB
checkpoint_completion_target = 0.9

# WAL 압축 (디스크 I/O 감소)
wal_compression = on

# Synchronous Commit (벤치마크 환경이므로 off 고려 가능, 기본값 on)
synchronous_commit = on

# ===================================================================
# LOGGING (성능 분석용)
# ===================================================================

# 1초 이상 소요되는 쿼리 로깅
log_min_duration_statement = 1000

# 로그 출력 형식
log_line_prefix = '%t [%p]: '
log_timezone = 'UTC'

# Checkpoint 로깅 (성능 분석용)
log_checkpoints = on

# 연결/종료 로그 (디버깅용, 프로덕션에서는 off 권장)
log_connections = off
log_disconnections = off

# Slow query 분석 (옵션)
# log_statement = 'all'  # 주의: 모든 쿼리 로깅, 성능 영향 큼

# ===================================================================
# AUTOVACUUM (테이블 통계 및 공간 회수)
# ===================================================================

autovacuum = on
autovacuum_max_workers = 3
autovacuum_naptime = 1min

# ===================================================================
# CLIENT CONNECTION DEFAULTS
# ===================================================================

# Locale 설정
datestyle = 'iso, mdy'
timezone = 'UTC'
lc_messages = 'en_US.utf8'
lc_monetary = 'en_US.utf8'
lc_numeric = 'en_US.utf8'
lc_time = 'en_US.utf8'

# 기본 텍스트 검색 설정
default_text_search_config = 'pg_catalog.english'

# ===================================================================
# LOCK MANAGEMENT
# ===================================================================

max_locks_per_transaction = 64
deadlock_timeout = 1s

# ===================================================================
# BACKGROUND WRITER (성능 최적화)
# ===================================================================

bgwriter_delay = 200ms
bgwriter_lru_maxpages = 100
bgwriter_lru_multiplier = 2.0

# ===================================================================
# QUERY TUNING
# ===================================================================

# JIT (Just-In-Time Compilation) - PostgreSQL 11+
jit = on
jit_above_cost = 100000

# ===================================================================
# STATISTICS (pg_stat_statements 확장 사용 시)
# ===================================================================

# shared_preload_libraries = 'pg_stat_statements'
# pg_stat_statements.max = 10000
# pg_stat_statements.track = all

# ===================================================================
# RESOURCE USAGE - Miscellaneous
# ===================================================================

# Huge Pages (Linux only, OS 설정 필요)
# huge_pages = try

# Temporary Files
temp_file_limit = -1

# ===================================================================
# ERROR HANDLING
# ===================================================================

# 재시작 시간 (충돌 복구)
restart_after_crash = on

# ===================================================================
# 주의사항
# ===================================================================
# 1. 이 설정은 벤치마크 환경에 최적화되어 있습니다.
# 2. 프로덕션 환경에서는 synchronous_commit=on, fsync=on 유지 필요
# 3. shared_buffers는 시스템 RAM에 따라 조정 필요
# 4. max_connections는 애플리케이션 연결 수에 맞춰 조정 필요
